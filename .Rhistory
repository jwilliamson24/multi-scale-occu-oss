library(vegan)
library(rpart)
library(rpart.plot)
library(party)
library(randomForest)
library(ggplot2)
#setwd("C:/Users/jasmi/OneDrive/Documents/Academic/OSU/Git/multivariate-analysis")
setwd("~/Library/CloudStorage/OneDrive-Personal/Documents/Academic/OSU/Git/multivariate-analysis")
source("Biostats.R")
dat <- read.csv("Harney_Fishes_2007.csv", row.names = 1)
spp_N <- colSums(dat[,16:ncol(dat)])
spp_0 <- subset(spp_N, spp_N == 0)
omit <- names(spp_0)
dat2 <- dat[,!(colnames(dat) %in% omit)]
dat3 <- dat2[rowSums(dat2[,16:ncol(dat2)]) >0, ]
dat3$Herbaceous[is.na(dat3$Herbaceous)] <- 0
dat3$Ann_Herb[is.na(dat3$Ann_Herb)] <- 0
dat3 <- dat3[complete.cases(dat3$SiteLength),]
dat_final <- dat3
fish <- dat_final[,16:ncol(dat_final)]
env <- dat_final[,1:15]
fish_red <- drop.var(fish, min.fo=1)
fish_dens <- fish_red
for(i in 1:nrow(fish_red)){
fish_dens[i,] <- fish_red[i,]/dat_final$SiteLength[i]
}
fish_dens_log <- log(fish_dens + 1)
drop <- c("Latitude","Longitude","SiteLength","SiteWidth","SurfaceArea")
env <- env[,!(colnames(env) %in% drop)]
env_cont <- env[,!(colnames(env) %in% c("SMU","Pop","NLCD_Cat"))]
env <- env[,!(colnames(env) %in% c("Ave_Max_D","Ann_Herb"))]
env_cont <- env_cont[,!(colnames(env_cont) %in% c("Ave_Max_D","Ann_Herb"))]
Trout_PA <- ifelse(fish$TROUT_RB > 0, "Present", "Absent")
Trout.tree <- rpart(Trout_PA ~ ., data=env_cont, minsplit=2, xval=5)
rpart.plot(Trout.tree)
plotcp(Trout.tree)
Trout.tree.prune <- prune(Trout.tree, 0.076)
rpart.plot(Trout.tree.prune)
Trout.tree2 <- rpart(fish$TROUT_RB ~ ., data=env_cont, minsplit=2, xval=5)
rpart.plot(Trout.tree2)
plotcp(Trout.tree2)
Trout.tree2.prune <- prune(Trout.tree2, 0.06)
rpart.plot(Trout.tree2.prune)
Trout.forest <- randomForest(as.factor(Trout_PA) ~ ., data=env_cont, ntree = 5000, mtry = 5, importance=TRUE, keep.forest=FALSE, na.action=na.omit)
Trout.forest
varImpPlot(Trout.forest)
ForestData <- as.data.frame(importance(Trout.forest))
ForestData <- ForestData[order(ForestData[,1]),]
ForestData$Var.Names <- row.names(ForestData)
colnames(ForestData) <- c("Absent","Present","MeanDec","IncNodePurity","Var.Names")
ForestData
ggplot(ForestData, aes(x=Var.Names, y=MeanDec)) +
geom_segment( aes(x=Var.Names, xend=Var.Names, y=0, yend=MeanDec), color="skyblue") +
geom_point(aes(size = IncNodePurity), color="blue", alpha=0.6) +
theme_light() +
coord_flip() +
theme(
legend.position="bottom",
panel.grid.major.y = element_blank(),
panel.border = element_blank(),
axis.ticks.y = element_blank()
)
Trout.forest2 <- randomForest(fish$TROUT_RB ~ ., data=env_cont, ntree = 5000, mtry = 5, importance=TRUE, keep.forest=FALSE, na.action=na.omit)
Trout.forest2
ForestData <- as.data.frame(importance(Trout.forest2))
ForestData <- ForestData[order(ForestData[,1]),]
ForestData$Var.Names <- row.names(ForestData)
colnames(ForestData) <- c("MeanDec","IncNodePurity","Var.Names")
ForestData
ggplot(ForestData, aes(x=Var.Names, y=MeanDec)) +
geom_segment( aes(x=Var.Names, xend=Var.Names, y=0, yend=MeanDec), color="skyblue") +
geom_point(aes(size = IncNodePurity), color="blue", alpha=0.6) +
theme_light() +
coord_flip() +
theme(
legend.position="bottom",
panel.grid.major.y = element_blank(),
panel.border = element_blank(),
axis.ticks.y = element_blank()
)
varImpPlot(Trout.forest)
Trout.forest
knitr::opts_chunk$set(echo = TRUE)
setwd("~/Library/CloudStorage/OneDrive-Personal/Documents/Academic/OSU/Git/multivariate-analysis")
library(vegan)
library(viridis)
library(MASSExtra)
library(ade4)
source("biostats.R")
#site-level data
#dat <- readRDS("C:/Users/jasmi/OneDrive/Documents/Academic/OSU/Git/oss-occu/data/site_level_matrix.rds")
dat <- readRDS("~/Library/CloudStorage/OneDrive-Personal/Documents/Academic/OSU/Git/oss-occu/data/site_level_matrix.rds")
row.names(dat) <- dat[,1]
#dat2 <- subset(dat, year=="2024")
sals <- dat[26:27]
env <- dat[1:25]
drop <- c("lat","long","stand","tree_farm","landowner","site_id","year","weather")
env <- env[,!(colnames(env) %in% drop)]
env_cont <- env[,-1]
drop <- c("jul_date","veg_cov","fwd_cov","dwd_count","size_cl","decay_cl","char_cl","length_cl" )
env_subset <- env_cont[,!(colnames(env_cont) %in% drop)]
View(sals)
oss_PA <- ifelse(sals$oss > 0, "Present", "Absent")
oss.tree <- rpart(oss_PA ~ ., data=env_subset, minsplit=2, xval=5)
rpart.plot(oss.tree)
plotcp(oss.tree)
oss.tree.prune <- prune(oss.tree, 0.044)
rpart.plot(oss.tree.prune)
oss.forest <- randomForest(as.factor(oss_PA) ~ ., data=env_subset, ntree = 5000, mtry = 5, importance=TRUE, keep.forest=FALSE, na.action=na.omit)
oss.forest
oss.forest
sqrt(8)
oss.forest <- randomForest(as.factor(oss_PA) ~ ., data=env_subset, ntree = 2000, mtry = 3, importance=TRUE, keep.forest=FALSE, na.action=na.omit)
oss.forest
varImpPlot(oss.forest)
ForestData <- as.data.frame(importance(oss.forest))
ForestData <- ForestData[order(ForestData[,1]),]
ForestData$Var.Names <- row.names(ForestData)
colnames(ForestData) <- c("Absent","Present","MeanDec","IncNodePurity","Var.Names")
ForestData
ggplot(ForestData, aes(x=Var.Names, y=MeanDec)) +
geom_segment( aes(x=Var.Names, xend=Var.Names, y=0, yend=MeanDec), color="skyblue") +
geom_point(aes(size = IncNodePurity), color="blue", alpha=0.6) +
theme_light() +
coord_flip() +
theme(
legend.position="bottom",
panel.grid.major.y = element_blank(),
panel.border = element_blank(),
axis.ticks.y = element_blank()
)
oss_PA <- ifelse(sals$oss > 0, "Present", "Absent")
oss.tree <- rpart(oss_PA ~ ., data=env_subset, minsplit=2, xval=5)
rpart.plot(oss.tree)
plotcp(oss.tree)
oss.tree.prune <- prune(oss.tree, 0.044)
rpart.plot(oss.tree.prune)
oss.forest <- randomForest(as.factor(oss_PA) ~ ., data=env_subset, ntree = 5000, mtry = 5, importance=TRUE, keep.forest=FALSE, na.action=na.omit)
oss.forest
table(oss_PA)
importance(oss.forest)
varImpPlot(oss.forest)
ForestData <- as.data.frame(importance(oss.forest))
ForestData <- ForestData[order(ForestData[,1]),]
ForestData$Var.Names <- row.names(ForestData)
colnames(ForestData) <- c("Absent","Present","MeanDec","IncNodePurity","Var.Names")
ForestData
ggplot(ForestData, aes(x=Var.Names, y=MeanDec)) +
geom_segment( aes(x=Var.Names, xend=Var.Names, y=0, yend=MeanDec), color="skyblue") +
geom_point(aes(size = IncNodePurity), color="blue", alpha=0.6) +
theme_light() +
coord_flip() +
theme(
legend.position="bottom",
panel.grid.major.y = element_blank(),
panel.border = element_blank(),
axis.ticks.y = element_blank()
)
install.packages("tinytex")
tinytex::install_tinytex()
install.packages("tinytex")
tinytex::install_tinytex()
install.packages("tinytex", dependencies = TRUE)
remove.packages("tinytex")
install.packages("tinytex")
tinytex::install_tinytex()
library(readr)
ENES_detections_and_covariates_2013_stacked <- read_csv("OneDrive/Documents/Academic/OSU/Git/oss-occu/data/pre-fire data/ENES detections and covariates 2013 - stacked.csv")
View(ENES_detections_and_covariates_2013_stacked)
setwd("~/Library/CloudStorage/OneDrive-Personal/Documents/Academic/OSU/Git/multi-scale-occu-oss")
##### Setup --------------------------------------------
library(ggplot2)
library(dplyr)
# Load data
e_covs <- read.csv("data/enes.prepost.multiscale.occu.csv")
o_covs <- read.csv("data/oss.prepost.multiscale.occu.csv")
load("data/msc-enes-data-workspace.RData")
load("data/multiscale_output_and_data_072125_enes_small.RData")
E = a2
load("data/multiscale_output_and_data_072525_oss_small.RData")
O = a2
# Estimates
summary(E)
summary(O)
# Combine
E2 = runjags::combine.mcmc(E)
O2 = runjags::combine.mcmc(O)
##### Plot predicted occupancy just for each year - ignore this plot its not useful ---------------------
dat <- as.matrix(E)  # # choose species # #
# Extract all samples for each year intercept (beta0.psi.year[t])
years <- 1:9
year_psi_preds <- lapply(years, function(t) plogis(dat[, paste0("beta0.psi.year[", t, "]")]))
year_means <- sapply(year_psi_preds, mean)
year_CIs <- sapply(year_psi_preds, function(x) quantile(x, probs = c(0.025, 0.975)))
# Put into data frame for ggplot
e_year_preds_df <- data.frame(
year = years,
predicted = year_means,
LCI = year_CIs[1, ],
UCI = year_CIs[2, ]
)
# Plot
ggplot(e_year_preds_df, aes(x = year, y = predicted)) +
geom_point(size = 2) +
geom_errorbar(aes(ymin = LCI, ymax = UCI), width = 0.2) +
ylab(expression("Predicted "*psi*"")) +
xlab("Year") +
ggtitle("Predicted Occupancy by Year - ENES") +
theme_classic()
##### Plot predicted occupancy for each year and treatment ---------------------
##### Method 1 ---------------------
dat <- as.matrix(E)
treatments <- c("UU", "BU", "HB", "HU", "BS")
years <- 1:9
# Create a function to compute logit_psi for a given treatment and year
get_psi_preds <- function(treatment, year_index) {
# Extract posterior samples
beta0 <- dat[, "beta0.psi"]
psi_year <- dat[, paste0("beta0.psi.year[", year_index, "]")]
# Set treatment coefficients (0 for control group)
beta_BU <- ifelse(treatment == "BU", dat[, "beta1.psi.BU"], 0)
beta_HB <- ifelse(treatment == "HB", dat[, "beta2.psi.HB"], 0)
beta_HU <- ifelse(treatment == "HU", dat[, "beta3.psi.HU"], 0)
beta_BS <- ifelse(treatment == "BS", dat[, "beta4.psi.BS"], 0)
# Set covs to mean
beta_lat <- 0
beta_lon <- 0
beta_elev <- 0
# Compute linear predictor and transform to probability
logit_psi <- beta0 + psi_year + beta_BU + beta_HB + beta_HU + beta_BS
psi <- plogis(logit_psi)
# combine
data.frame(
treatment = treatment,
year = year_index,
mean_psi = mean(psi),
lci = quantile(psi, 0.025),
uci = quantile(psi, 0.975)
)
}
# dataframe with only valid year-treatment combos
valid_combos <- data.frame(
year = c(1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 8, 8, 8, 9, 9, 9, 9, 9),
treatment = c("UU", "HU", "UU", "HU", "UU", "HU", "UU", "HU",
"UU", "HU", "UU", "HU", "UU", "HU",
"UU", "HU", "BU", "HB", "BS", "UU", "HU", "BU", "HB", "BS"))
# predictions for each trt each year
all_preds1 <- do.call(rbind, lapply(1:max(years), function(t) {
# get treatments for this year
trts_for_year <- valid_combos$treatment[valid_combos$year == t]
do.call(rbind, lapply(trts_for_year, function(trt) get_psi_preds(trt, t)))
}))
row.names(all_preds1) <- NULL
head(all_preds1)
# plot
ggplot(all_preds1, aes(x = factor(year), y = mean_psi, color = treatment, group = treatment)) +
geom_point(position = position_dodge(0.3), size = 2.5) +
geom_errorbar(aes(ymin = lci, ymax = uci), position = position_dodge(0.3), width = 0.2) +
labs(x = "Year", y = "Predicted Occupancy (ψ)", title = "Occupancy by Treatment and Year - E") +
theme_minimal()
### Method 2 --------------------
dat <- as.matrix(E)
get_psi_preds <- function(treatment, year) {
# Intercept for year
beta0 <- dat[, "beta0.psi"] + dat[, paste0("beta0.psi.year[", year, "]")]
# Treatment coefficients (UU is reference, so no added term)
treatment_term <- switch(treatment,
"BU" = dat[, "beta1.psi.BU"],
"HB" = dat[, "beta2.psi.HB"],
"HU" = dat[, "beta3.psi.HU"],
"BS" = dat[, "beta4.psi.BS"],
0  # for "UU"
)
# Add other covariates, set to mean (0)
cov_effect <- 0
cov_effect <- cov_effect +
0 * dat[, "beta8.psi.elev"] +
0 * dat[, "beta5.psi.lat"] +
0 * dat[, "beta6.psi.lon"]
# transform
logit_psi <- beta0 + treatment_term + cov_effect
psi <- plogis(logit_psi)
# combine
data.frame(
treatment = treatment,
year = year,
mean_psi = mean(psi),
lci = quantile(psi, 0.025),
uci = quantile(psi, 0.975)
)
}
# dataframe with only valid year-treatment combos
valid_combos <- data.frame(
year = c(1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 8, 8, 8, 9, 9, 9, 9, 9),
treatment = c("UU", "HU", "UU", "HU", "UU", "HU", "UU", "HU",
"UU", "HU", "UU", "HU", "UU", "HU",
"UU", "HU", "BU", "HB", "BS", "UU", "HU", "BU", "HB", "BS"))
# preds for each trt each year
all_preds2 <- do.call(rbind, lapply(1:nrow(valid_combos), function(i) {
get_psi_preds(valid_combos$treatment[i], valid_combos$year[i])
}))
# plot
ggplot(all_preds2, aes(x = factor(year), y = mean_psi, color = treatment, group = treatment)) +
geom_point(position = position_dodge(0.3), size = 3) +
geom_errorbar(aes(ymin = lci, ymax = uci), width = 0.1, position = position_dodge(0.3)) +
labs(x = "Year", y = "Predicted occupancy (ψ)", color = "Treatment") +
theme_bw(base_size = 14)
